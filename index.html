<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Territory Run - Claim Your City</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #map { height: 100vh; width: 100%; }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Auth Screen -->
    <div id="auth-screen" class="hidden w-full h-screen bg-gray-900 text-white flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="bg-gray-800 rounded-lg shadow-xl p-8">
                <div class="text-center mb-8">
                    <svg class="w-16 h-16 mx-auto mb-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <h1 class="text-3xl font-bold mb-2">Territory Run</h1>
                    <p class="text-gray-400">Claim your city, one run at a time</p>
                </div>

                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-xl font-semibold mb-4">Log In</h2>
                    <form id="login-form-element" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="login-email" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="login-password" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div id="login-error" class="hidden text-red-400 text-sm"></div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 py-3 rounded-lg font-semibold transition-colors">
                            Log In
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-400">
                        Don't have an account? 
                        <button id="show-signup" class="text-blue-400 hover:text-blue-300">Sign Up</button>
                    </p>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <h2 class="text-xl font-semibold mb-4">Sign Up</h2>
                    <form id="signup-form-element" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Email</label>
                            <input type="email" id="signup-email" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Password</label>
                            <input type="password" id="signup-password" required minlength="6" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-blue-500">
                            <p class="text-xs text-gray-400 mt-1">At least 6 characters</p>
                        </div>
                        <div id="signup-error" class="hidden text-red-400 text-sm"></div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 py-3 rounded-lg font-semibold transition-colors">
                            Sign Up
                        </button>
                    </form>
                    <p class="mt-4 text-center text-sm text-gray-400">
                        Already have an account? 
                        <button id="show-login" class="text-blue-400 hover:text-blue-300">Log In</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden w-full h-screen bg-gray-900 text-white flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="bg-gray-800 p-3 md:p-4 shadow-lg flex-shrink-0">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2 md:gap-3">
                    <svg class="w-6 h-6 md:w-8 md:h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <div>
                        <h1 class="text-lg md:text-2xl font-bold">Territory Run</h1>
                        <div class="flex items-center gap-2">
                            <p class="text-xs md:text-sm text-gray-400" id="user-email"></p>
                            <span id="gps-indicator" class="hidden flex items-center gap-1 text-xs text-green-400">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                                GPS Active
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2 md:gap-4">
                    <button id="start-btn" class="bg-green-500 hover:bg-green-600 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold flex items-center gap-1 md:gap-2 transition-colors text-sm md:text-base">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="hidden sm:inline">Start Run</span>
                        <span class="sm:hidden">Start</span>
                    </button>
                    <button id="stop-btn" class="hidden bg-red-500 hover:bg-red-600 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold flex items-center gap-1 md:gap-2 transition-colors text-sm md:text-base animate-pulse">
                        <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                        </svg>
                        <span class="hidden sm:inline">Stop Run</span>
                        <span class="sm:hidden">Stop</span>
                    </button>
                    <button id="logout-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 md:px-4 md:py-2 rounded-lg text-sm transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Map Area -->
            <div class="flex-1 relative order-2 md:order-1" style="min-height: 50vh;">
                <div id="map" class="w-full h-full"></div>
                
                <div id="loading-indicator" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 bg-opacity-75 z-[2000]">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-lg">Loading your runs...</p>
                    </div>
                </div>
                
                <div id="tracking-indicator" class="hidden absolute top-2 left-2 md:top-4 md:left-4 bg-green-500 px-3 py-2 md:px-4 md:py-2 rounded-lg shadow-lg z-[1000] text-sm md:text-base">
                    <span id="tracking-text">Tap map to add points</span>
                </div>
                
                <div id="points-counter" class="hidden absolute top-12 left-2 md:top-16 md:left-4 bg-gray-800 px-3 py-1 md:px-4 md:py-2 rounded-lg shadow-lg z-[1000]">
                    <span class="text-xs md:text-sm">Points: <span id="point-count">0</span></span>
                </div>
            </div>

            <!-- Stats Sidebar -->
            <div class="w-full md:w-80 bg-gray-800 p-4 md:p-6 overflow-y-auto order-1 md:order-2 max-h-[40vh] md:max-h-full">
                <h2 class="text-lg md:text-xl font-bold mb-4 md:mb-6 flex items-center gap-2">
                    <svg class="w-5 h-5 md:w-6 md:h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                    </svg>
                    Your Stats
                </h2>
                
                <div class="grid grid-cols-3 md:grid-cols-1 gap-3 md:gap-4">
                    <div class="bg-gray-700 p-3 md:p-4 rounded-lg">
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-1 md:gap-2 mb-1 md:mb-2">
                            <span class="text-xs md:text-sm text-gray-300">Territory</span>
                        </div>
                        <div class="text-xl md:text-3xl font-bold text-blue-400">
                            <span id="total-area">0.000</span>
                        </div>
                        <div class="text-xs text-gray-400">km²</div>
                    </div>
                    
                    <div class="bg-gray-700 p-3 md:p-4 rounded-lg">
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-1 md:gap-2 mb-1 md:mb-2">
                            <span class="text-xs md:text-sm text-gray-300">Distance</span>
                        </div>
                        <div class="text-xl md:text-3xl font-bold text-green-400">
                            <span id="total-distance">0.00</span>
                        </div>
                        <div class="text-xs text-gray-400">km</div>
                    </div>
                    
                    <div class="bg-gray-700 p-3 md:p-4 rounded-lg">
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-1 md:gap-2 mb-1 md:mb-2">
                            <span class="text-xs md:text-sm text-gray-300">Runs</span>
                        </div>
                        <div class="text-xl md:text-3xl font-bold text-purple-400">
                            <span id="total-runs">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 md:mt-8">
                    <h3 class="font-semibold mb-4">Recent Runs</h3>
                    <div id="runs-list" class="space-y-3"></div>
                </div>
                
                <div class="mt-4 md:mt-8 p-3 md:p-4 bg-gray-700 rounded-lg text-xs md:text-sm">
                    <h4 class="font-semibold mb-2">How to use:</h4>
                    <ol class="list-decimal list-inside space-y-1 text-gray-300">
                        <li>Click "Start Run"</li>
                        <li>Choose GPS or manual mode</li>
                        <li>Run/walk to create territory</li>
                        <li>Click "Stop" to save your run</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://cycowcfrbinxtphgzcxl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5Y293Y2ZyYmlueHRwaGd6Y3hsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDQwOTksImV4cCI6MjA4MjQyMDA5OX0.hgF5rR0GKjOmVyX8MedAnR1H-njT0H8IUzveI0aX87E';
        const supabase = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

        let currentUser = null;
        let map, isTracking = false, useGPS = false, gpsWatchId = null;
        let currentPath = [], completedRuns = [];
        let totalArea = 0, totalDistance = 0;
        let pathLayer, territoryLayer, userMarker;

        // Check authentication state
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-email').textContent = currentUser.email;
            initializeMap();
            loadRuns();
        }

        // Auth form handlers
        document.getElementById('show-signup').addEventListener('click', () => {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', () => {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        });

        document.getElementById('login-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                currentUser = data.user;
                showApp();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('signup-form-element').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const errorEl = document.getElementById('signup-error');

            try {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                currentUser = data.user;
                showApp();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            currentUser = null;
            if (map) map.remove();
            map = null;
            showAuth();
        });

        function initializeMap() {
            if (map) return;
            
            const CHANDIGARH = [30.7333, 76.7794];
            map = L.map('map').setView(CHANDIGARH, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            pathLayer = L.layerGroup().addTo(map);
            territoryLayer = L.layerGroup().addTo(map);

            map.on('click', (e) => {
                if (isTracking && !useGPS) {
                    currentPath.push(e.latlng);
                    updatePath();
                }
            });
        }

        async function loadRuns() {
            if (!supabase || !currentUser) return;
            
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            try {
                const { data, error } = await supabase
                    .from('runs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                completedRuns = data || [];
                updateStats();
                updateRunsList();
                drawAllTerritories();
            } catch (error) {
                console.error('Error loading runs:', error);
            } finally {
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        async function saveRun(run) {
            if (!supabase || !currentUser) return null;
            
            try {
                const { data, error } = await supabase
                    .from('runs')
                    .insert([{
                        user_id: currentUser.id,
                        path: run.path,
                        buffered_area: run.bufferedArea,
                        area: run.area,
                        distance: run.distance
                    }])
                    .select();

                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving run:', error);
                return null;
            }
        }

        function calculateDistance(latlng1, latlng2) {
            const R = 6371;
            const dLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
            const dLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(latlng1.lat * Math.PI / 180) * Math.cos(latlng2.lat * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculatePolygonArea(latlngs) {
            if (latlngs.length < 3) return 0;
            const R = 6371;
            let area = 0;
            for (let i = 0; i < latlngs.length; i++) {
                const j = (i + 1) % latlngs.length;
                const lat1 = latlngs[i].lat * Math.PI / 180;
                const lat2 = latlngs[j].lat * Math.PI / 180;
                const lng1 = latlngs[i].lng * Math.PI / 180;
                const lng2 = latlngs[j].lng * Math.PI / 180;
                area += (lng2 - lng1) * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            return Math.abs(area * R * R / 2);
        }

        function createBufferedPolygon(latlngs, bufferMeters = 50) {
            if (latlngs.length < 2) return null;
            const buffered = [];
            const metersPerDegree = 111320;
            const buffer = bufferMeters / metersPerDegree;
            
            for (let i = 0; i < latlngs.length; i++) {
                const curr = latlngs[i];
                let perpLat = 0, perpLng = 0;
                if (i < latlngs.length - 1) {
                    const next = latlngs[i + 1];
                    const dLat = next.lat - curr.lat;
                    const dLng = next.lng - curr.lng;
                    const len = Math.sqrt(dLat * dLat + dLng * dLng);
                    if (len > 0) {
                        perpLat = -dLng / len * buffer;
                        perpLng = dLat / len * buffer;
                    }
                }
                buffered.push(L.latLng(curr.lat + perpLat, curr.lng + perpLng));
            }
            
            for (let i = latlngs.length - 1; i >= 0; i--) {
                const curr = latlngs[i];
                let perpLat = 0, perpLng = 0;
                if (i > 0) {
                    const prev = latlngs[i - 1];
                    const dLat = curr.lat - prev.lat;
                    const dLng = curr.lng - prev.lng;
                    const len = Math.sqrt(dLat * dLat + dLng * dLng);
                    if (len > 0) {
                        perpLat = -dLng / len * buffer;
                        perpLng = dLat / len * buffer;
                    }
                }
                buffered.push(L.latLng(curr.lat - perpLat, curr.lng - perpLng));
            }
            return buffered;
        }

        function updatePath() {
            pathLayer.clearLayers();
            if (currentPath.length > 0) {
                L.polyline(currentPath, { color: '#10b981', weight: 4, opacity: 0.8 }).addTo(pathLayer);
                currentPath.forEach((latlng, idx) => {
                    L.circleMarker(latlng, {
                        radius: idx === 0 ? 8 : 5,
                        fillColor: idx === 0 ? '#10b981' : '#34d399',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(pathLayer);
                });
                
                if (currentPath.length > 2) {
                    const buffered = createBufferedPolygon(currentPath);
                    if (buffered) {
                        L.polygon(buffered, {
                            color: '#10b981',
                            weight: 2,
                            fillColor: '#10b981',
                            fillOpacity: 0.2
                        }).addTo(pathLayer);
                    }
                }
            }
            document.getElementById('point-count').textContent = currentPath.length;
        }

        function drawAllTerritories() {
            territoryLayer.clearLayers();
            completedRuns.forEach((run, idx) => {
                const path = run.path.map(p => L.latLng(p.lat, p.lng));
                const bufferedArea = run.buffered_area ? run.buffered_area.map(p => L.latLng(p.lat, p.lng)) : null;
                
                if (bufferedArea) {
                    L.polygon(bufferedArea, {
                        color: '#3b82f6',
                        weight: 2,
                        fillColor: '#3b82f6',
                        fillOpacity: Math.max(0.15, 0.3 - idx * 0.05)
                    }).addTo(territoryLayer);
                }
                L.polyline(path, { color: '#1e40af', weight: 3, opacity: 0.7 }).addTo(territoryLayer);
            });
        }

        function updateStats() {
            totalArea = completedRuns.reduce((sum, run) => sum + parseFloat(run.area), 0);
            totalDistance = completedRuns.reduce((sum, run) => sum + parseFloat(run.distance), 0);
            
            document.getElementById('total-area').textContent = totalArea.toFixed(3);
            document.getElementById('total-distance').textContent = totalDistance.toFixed(2);
            document.getElementById('total-runs').textContent = completedRuns.length;
        }

        function updateRunsList() {
            const listEl = document.getElementById('runs-list');
            if (completedRuns.length === 0) {
                listEl.innerHTML = '<p class="text-gray-400 text-sm">No runs yet. Start your first run!</p>';
                return;
            }
            
            listEl.innerHTML = completedRuns.slice(0, 5).map((run, idx) => `
                <div class="bg-gray-700 p-3 rounded-lg text-sm">
                    <div class="flex justify-between mb-1">
                        <span class="text-gray-300">Run #${completedRuns.length - idx}</span>
                        <span class="text-blue-400">${parseFloat(run.area).toFixed(3)} km²</span>
                    </div>
                    <div class="text-gray-400 text-xs">
                        ${parseFloat(run.distance).toFixed(2)} km • ${run.path.length} points
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            const wantsGPS = confirm('Enable GPS tracking for real runs?\n\nClick OK for GPS mode (real running)\nClick Cancel for manual mode (click on map)');
            
            if (wantsGPS && 'geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userPos = [position.coords.latitude, position.coords.longitude];
                        map.setView(userPos, 16);
                        useGPS = true;
                        document.getElementById('gps-indicator').classList.remove('hidden');
                        document.getElementById('tracking-text').textContent = 'Recording GPS...';
                        
                        gpsWatchId = navigator.geolocation.watchPosition(
                            (pos) => {
                                const newPoint = L.latLng(pos.coords.latitude, pos.coords.longitude);
                                if (currentPath.length === 0 || calculateDistance(currentPath[currentPath.length - 1], newPoint) > 0.005) {
                                    currentPath.push(newPoint);
                                    updatePath();
                                }
                                if (userMarker) {
                                    userMarker.setLatLng(newPoint);
                                } else {
                                    userMarker = L.circleMarker(newPoint, {
                                        radius: 10,
                                        fillColor: '#10b981',
                                        color: '#fff',
                                        weight: 3,
                                        fillOpacity: 1
                                    }).addTo(map);
                                }
                            },
                            (error) => alert('GPS Error: ' + error.message),
                            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                        );
                    },
                    () => alert('GPS access denied. Using manual mode.')
                );
            }
            
            isTracking = true;
            currentPath = [];
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('tracking-indicator').classList.remove('hidden');
            document.getElementById('points-counter').classList.remove('hidden');
        });

        document.getElementById('stop-btn').addEventListener('click', async () => {
            if (currentPath.length < 3) {
                alert('Need at least 3 points to create a territory!');
                currentPath = [];
                isTracking = false;
                document.getElementById('start-btn').classList.remove('hidden');
                document.getElementById('stop-btn').classList.add('hidden');
                document.getElementById('tracking-indicator').classList.add('hidden');
                document.getElementById('points-counter').classList.add('hidden');
                return;
            }
            
            let distance = 0;
            for (let i = 1; i < currentPath.length; i++) {
                distance += calculateDistance(currentPath[i - 1], currentPath[i]);
            }
            
            const bufferedArea = createBufferedPolygon(currentPath);
            const area = bufferedArea ? calculatePolygonArea(bufferedArea) : 0;
            
            const newRun = {
                path: currentPath.map(p => ({ lat: p.lat, lng: p.lng })),
                bufferedArea: bufferedArea ? bufferedArea.map(p => ({ lat: p.lat, lng: p.lng })) : null,
                area,
                distance
            };
            
            const savedRun = await saveRun(newRun);
            if (savedRun) {
                completedRuns.unshift(savedRun);
            }
            
            updateStats();
            updateRunsList();
            drawAllTerritories();
            
            if (gpsWatchId) navigator.geolocation.clearWatch(gpsWatchId);
            isTracking = false;
            useGPS = false;
            currentPath = [];
            pathLayer.clearLayers();
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('tracking-indicator').classList.add('hidden');
            document.getElementById('points-counter').classList.add('hidden');
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
